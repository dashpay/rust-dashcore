# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

dash-spv-ffi provides C-compatible FFI bindings for the Dash SPV (Simplified Payment Verification) client. It wraps the Rust dash-spv library to enable usage from C, Swift, and other languages via a stable ABI.

## Build Commands

### Rust Library Build
```bash
# Debug build
cargo build

# Release build (recommended for production)
cargo build --release

# Build for specific iOS targets
cargo build --release --target aarch64-apple-ios
cargo build --release --target aarch64-apple-ios-sim
```

### Header Generation
The C header is auto-generated by the build script. To regenerate manually:
```bash
cbindgen --config cbindgen.toml --crate dash-spv-ffi --output include/dash_spv_ffi.h
```

### Unified SDK Build
For iOS integration with platform-ios:
```bash
# First build dash-spv-ffi for iOS targets (REQUIRED!)
cargo build --release --target aarch64-apple-ios
cargo build --release --target aarch64-apple-ios-sim

# Then build the unified SDK
cd ../../platform-ios/packages/rs-sdk-ffi
./build_ios.sh

# Copy to iOS project
cp -R build/DashUnifiedSDK.xcframework ../../../dashpay-ios/DashPayiOS/Libraries/
```

**Important**: The unified SDK build process (`build_ios.sh`) merges dash-spv-ffi with platform SDK. You MUST build dash-spv-ffi first or changes won't be included!

## Testing

### Rust Tests
```bash
# Run all tests
cargo test

# Run specific test
cargo test test_client_lifecycle

# Run with output
cargo test -- --nocapture

# Run tests with real Dash node (requires DASH_SPV_IP env var)
DASH_SPV_IP=192.168.1.100 cargo test -- --ignored
```

### C Tests
```bash
cd tests/c_tests

# Build and run all tests
make test

# Run specific test
make test_basic && ./test_basic

# Clean build artifacts
make clean
```

## Architecture

### Core Components

**FFI Wrapper Layer** (`src/`):
- `client.rs` - SPV client operations (connect, sync, broadcast)
- `config.rs` - Client configuration (network, peers, validation)
- `wallet.rs` - Wallet operations (addresses, balances, UTXOs)
- `callbacks.rs` - Async callback system for progress/events
- `types.rs` - FFI-safe type conversions
- `error.rs` - Thread-local error handling
- `platform_integration.rs` - Platform SDK integration support

**Key Design Patterns**:
1. **Opaque Pointers**: Complex Rust types are exposed as opaque pointers (`FFIDashSpvClient*`)
2. **Explicit Memory Management**: All FFI types have corresponding `_destroy()` functions
3. **Error Handling**: Uses thread-local storage for error propagation
4. **Callbacks**: Async operations use C function pointers for progress/completion

### FFI Safety Rules

1. **String Handling**: 
   - Rust strings are returned as `*const c_char` (caller must free with `dash_string_free`)
   - Input strings are `*const c_char` (borrowed, not freed)

2. **Memory Ownership**:
   - Functions returning pointers transfer ownership (caller must destroy)
   - Functions taking pointers borrow (caller retains ownership)

3. **Thread Safety**:
   - Client operations are thread-safe
   - Callbacks may be invoked from any thread

### Integration with Unified SDK

This crate can be used standalone or as part of the unified SDK:
- **Standalone**: Produces `libdash_spv_ffi.a` with `dash_spv_ffi.h`
- **Unified**: Combined with platform SDK in `DashUnifiedSDK.xcframework`

The unified SDK merges headers and resolves type conflicts between Core and Platform layers.

## Common Development Tasks

### Adding New FFI Functions
1. Implement Rust function in appropriate module with `#[no_mangle] extern "C"`
2. Add cbindgen annotations for complex types
3. Run `cargo build` to regenerate header
4. Add corresponding test in `tests/unit/`
5. Add C test in `tests/c_tests/`

### Debugging FFI Issues
- Check `dash_spv_ffi_get_last_error()` for error details
- Use `RUST_LOG=debug` for verbose logging
- Verify memory management (matching create/destroy calls)
- Test with AddressSanitizer: `RUSTFLAGS="-Z sanitizer=address" cargo test`

### Platform-Specific Builds
- iOS: Use `--target aarch64-apple-ios` or `aarch64-apple-ios-sim`
- Android: Use appropriate NDK target
- Linux/macOS: Default target works

## Dependencies

Key dependencies from Cargo.toml:
- `dash-spv` - Core SPV implementation (local path)
- `dashcore` - Dash protocol types (local path)
- `tokio` - Async runtime
- `cbindgen` - C header generation (build dependency)